<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>FleetFlow ‚Äî Fleet Management</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.3.1/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.3.1/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#09090b;--surface:#111113;--card:#18181b;--border:#27272a;
  --amber:#f59e0b;--amber2:#fbbf24;--red:#ef4444;--green:#22c55e;
  --blue:#60a5fa;--muted:#52525b;--text:#f4f4f5;--subtle:#71717a;
}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:#3f3f46;border-radius:2px}
::-webkit-scrollbar-thumb:hover{background:var(--amber)}

/* Layout */
.app{display:flex;height:100vh;overflow:hidden}
.sidebar{width:220px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column}
.main{flex:1;overflow-y:auto;background:var(--bg)}
.page{padding:40px;max-width:1200px;margin:0 auto;animation:fadeIn .25s ease}

/* Logo */
.logo{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.logo-icon{width:28px;height:28px;background:var(--amber);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:14px}
.logo-text{font-family:'Bebas Neue',cursive;font-size:20px;letter-spacing:.15em;color:var(--text)}

/* Nav */
.nav{flex:1;padding:12px 10px;overflow-y:auto}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:6px;cursor:pointer;font-size:13px;color:var(--subtle);transition:all .15s;margin-bottom:2px;border:none;background:transparent;width:100%;text-align:left}
.nav-item:hover{background:var(--card);color:var(--text)}
.nav-item.active{background:rgba(245,158,11,.12);color:var(--amber)}
.nav-icon{font-size:15px;width:18px;text-align:center}

/* User bar */
.user-bar{border-top:1px solid var(--border);padding:14px;font-size:12px}
.user-name{font-weight:500;color:var(--text);margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-email{color:var(--subtle);margin-bottom:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.role-tag{display:inline-block;font-family:'JetBrains Mono',monospace;font-size:10px;padding:2px 7px;background:rgba(245,158,11,.12);color:var(--amber);border-radius:3px;margin-bottom:8px}
.logout-btn{background:none;border:none;color:var(--subtle);font-size:12px;cursor:pointer;padding:0;font-family:'DM Sans',sans-serif}
.logout-btn:hover{color:var(--red)}

/* Page header */
.page-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px}
.page-title{font-family:'Bebas Neue',cursive;font-size:44px;letter-spacing:.12em;color:var(--text);line-height:1}
.page-sub{color:var(--subtle);font-size:13px;margin-top:4px}

/* Stat cards */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:28px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:20px;transition:border-color .2s}
.stat-card:hover{border-color:rgba(245,158,11,.3)}
.stat-label{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--subtle);margin-bottom:10px}
.stat-value{font-family:'Bebas Neue',cursive;font-size:42px;letter-spacing:.05em;line-height:1}
.stat-sub{font-size:11px;color:var(--subtle);margin-top:4px}

/* Table */
.table-wrap{background:var(--card);border:1px solid var(--border);border-radius:8px;overflow:hidden}
table{width:100%;border-collapse:collapse}
th{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:10px 16px;text-align:left;border-bottom:1px solid var(--border)}
td{padding:12px 16px;border-bottom:1px solid #1f1f23;font-size:13px}
tr:last-child td{border-bottom:none}
tr:hover td{background:#1c1c1f;cursor:pointer}
.td-main{font-weight:500;color:var(--text)}
.td-sub{font-size:11px;color:var(--subtle);margin-top:2px}
.td-mono{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--subtle)}
.td-amber{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--amber)}

/* Badge */
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 9px;border-radius:3px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:500;letter-spacing:.05em;text-transform:uppercase}
.badge-dot{width:5px;height:5px;border-radius:50%}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:5px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .15s}
.btn-primary{background:var(--amber);color:#000}
.btn-primary:hover{background:var(--amber2)}
.btn-ghost{background:transparent;color:var(--subtle);border:1px solid var(--border)}
.btn-ghost:hover{border-color:#444;color:var(--text)}
.btn-danger{background:transparent;color:var(--red);border:1px solid rgba(239,68,68,.25)}
.btn-danger:hover{background:rgba(239,68,68,.08)}
.btn-blue{background:transparent;color:var(--blue);border:1px solid rgba(96,165,250,.25)}
.btn-blue:hover{background:rgba(96,165,250,.08)}
.btn-green{background:transparent;color:var(--green);border:1px solid rgba(34,197,94,.25)}
.btn-green:hover{background:rgba(34,197,94,.08)}
.btn-sm{padding:5px 10px;font-size:12px}

/* Filter bar */
.filter-bar{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap}

/* Inputs */
.input{background:var(--surface);border:1px solid var(--border);color:var(--text);border-radius:5px;padding:8px 12px;font-family:'DM Sans',sans-serif;font-size:13px;width:100%;outline:none;transition:border-color .15s}
.input:focus{border-color:var(--amber)}
.input::placeholder{color:#3f3f46}
select.input option{background:var(--surface)}
textarea.input{resize:vertical}
.input-auto{width:auto}

/* Form */
.form-field{margin-bottom:4px}
.form-label{display:block;font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--subtle);margin-bottom:6px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn .15s}
.modal{background:var(--card);border:1px solid var(--border);border-radius:10px;width:100%;max-width:520px;overflow:hidden;animation:slideUp .2s ease}
.modal-wide{max-width:680px}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid var(--border)}
.modal-title{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:.15em;text-transform:uppercase;color:var(--amber)}
.modal-close{background:none;border:none;color:var(--subtle);cursor:pointer;font-size:18px;line-height:1;padding:0}
.modal-close:hover{color:var(--text)}
.modal-body{padding:22px}

/* Error */
.error-banner{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);border-radius:5px;padding:10px 14px;color:var(--red);font-size:12px;margin-bottom:14px;display:flex;gap:8px;align-items:flex-start}

/* Alert */
.alert-item{display:flex;gap:10px;align-items:flex-start;padding:10px 13px;border-radius:5px;border:1px solid var(--border);background:var(--surface);margin-bottom:6px;font-size:12px;color:var(--subtle)}

/* Login */
.login-wrap{min-height:100vh;display:flex;background:var(--bg)}
.login-left{width:50%;padding:50px;border-right:1px solid var(--border);display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden}
.login-grid{position:absolute;inset:0;opacity:.04;background-image:linear-gradient(var(--amber) 1px,transparent 1px),linear-gradient(90deg,var(--amber) 1px,transparent 1px);background-size:48px 48px}
.login-right{flex:1;display:flex;align-items:center;justify-content:center;padding:40px}
.login-form-wrap{width:100%;max-width:340px}
.login-title{font-family:'Bebas Neue',cursive;font-size:38px;letter-spacing:.15em;margin-bottom:6px}
.login-sub{color:var(--subtle);font-size:13px;margin-bottom:28px}
.login-big{font-family:'Bebas Neue',cursive;font-size:64px;letter-spacing:.1em;line-height:.9;color:var(--text);margin-bottom:16px}
.login-desc{color:var(--subtle);font-size:13px;max-width:280px;line-height:1.6}
.login-stats{display:flex;gap:36px}
.login-stat-num{font-family:'Bebas Neue',cursive;font-size:30px;color:var(--amber)}
.login-stat-lbl{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--subtle);letter-spacing:.08em}

/* Empty */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;color:var(--muted)}
.empty-icon{font-size:32px;margin-bottom:10px;opacity:.3}
.empty-text{font-family:'JetBrains Mono',monospace;font-size:11px;letter-spacing:.1em;text-transform:uppercase}

/* Total row */
.total-highlight{background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.2);border-radius:6px;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.total-label{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--subtle);text-transform:uppercase;letter-spacing:.08em}
.total-value{font-family:'Bebas Neue',cursive;font-size:28px;color:var(--amber);letter-spacing:.05em}

/* Charts */
.charts-row{display:grid;grid-template-columns:1fr 2fr;gap:16px;margin-bottom:20px}
.chart-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:20px}
.chart-title{font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--subtle);margin-bottom:18px}

/* Mini bar chart */
.mini-bars{display:flex;align-items:flex-end;gap:8px;height:100px}
.mini-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px}
.mini-bar{width:100%;border-radius:3px 3px 0 0;transition:opacity .2s;min-height:4px}
.mini-bar-label{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--subtle);text-align:center;letter-spacing:.05em}
.mini-bar-val{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text)}

/* Spinner */
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--amber);border-radius:50%;animation:spin .7s linear infinite;margin:60px auto;display:block}

/* Safety score */
.score-high{color:var(--green);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500}
.score-mid{color:var(--amber);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500}
.score-low{color:var(--red);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500}

/* Confirm */
.confirm-msg{display:flex;gap:10px;margin-bottom:22px;font-size:13px;color:var(--subtle);line-height:1.5}
.btn-row{display:flex;gap:10px;justify-content:flex-end;margin-top:6px}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useCallback, createContext, useContext } = React;

// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// IMPORTANT: Replace this with your actual Railway backend URL
const API_BASE = 'https://backend-updated-production-de7b.up.railway.app/api/v1';

// ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const req = async (method, path, body, params) => {
  const token = localStorage.getItem('ff_token');
  const url = new URL(API_BASE + path);
  if (params) Object.entries(params).forEach(([k,v]) => v != null && url.searchParams.set(k, v));
  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json', ...(token ? { Authorization: `Bearer ${token}` } : {}) },
    body: body ? JSON.stringify(body) : undefined,
  });
  if (res.status === 401) { localStorage.removeItem('ff_token'); window.location.reload(); }
  if (!res.ok) { const e = await res.json().catch(() => ({})); throw new Error(e.detail || 'Request failed'); }
  if (res.status === 204) return null;
  return res.json();
};

const formReq = async (path, formData) => {
  const res = await fetch(API_BASE + path, { method: 'POST', body: formData });
  if (!res.ok) { const e = await res.json().catch(() => ({})); throw new Error(e.detail || 'Login failed'); }
  return res.json();
};

const api = {
  login: (email, pw) => { const f = new URLSearchParams(); f.append('username', email); f.append('password', pw); return formReq('/auth/token', f); },
  me: () => req('GET', '/auth/me'),
  vehicles: (p) => req('GET', '/vehicles/', null, p),
  vehiclesAvail: () => req('GET', '/vehicles/available'),
  createVehicle: (d) => req('POST', '/vehicles/', d),
  updateVehicle: (id, d) => req('PATCH', `/vehicles/${id}`, d),
  retireVehicle: (id) => req('DELETE', `/vehicles/${id}`),
  drivers: (p) => req('GET', '/drivers/', null, p),
  driversAvail: () => req('GET', '/drivers/available'),
  createDriver: (d) => req('POST', '/drivers/', d),
  updateDriver: (id, d) => req('PATCH', `/drivers/${id}`, d),
  expiringLicenses: (days) => req('GET', '/drivers/expiring-licenses', null, { within_days: days }),
  trips: (p) => req('GET', '/trips/', null, p),
  createTrip: (d) => req('POST', '/trips/', d),
  dispatchTrip: (id) => req('PATCH', `/trips/${id}/dispatch`),
  completeTrip: (id) => req('PATCH', `/trips/${id}/complete`),
  cancelTrip: (id, reason) => req('PATCH', `/trips/${id}/cancel`, null, { cancel_reason: reason }),
  fuel: (p) => req('GET', '/fuel/', null, p),
  createFuel: (d) => req('POST', '/fuel/', d),
  maintenance: (p) => req('GET', '/maintenance/', null, p),
  createMaintenance: (d) => req('POST', '/maintenance/', d),
  updateMaintenance: (id, d) => req('PATCH', `/maintenance/${id}`, d),
  expenses: (p) => req('GET', '/expenses/', null, p),
  createExpense: (d) => req('POST', '/expenses/', d),
};

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt = {
  date: (d) => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî',
  datetime: (d) => d ? new Date(d).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) : '‚Äî',
  currency: (n) => n != null ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n) : '‚Äî',
  num: (n, u = '') => n != null ? `${Number(n).toLocaleString()}${u ? ' ' + u : ''}` : '‚Äî',
};

const STATUS_COLORS = {
  available:  { bg: 'rgba(34,197,94,.12)',  text: '#22c55e', dot: '#22c55e' },
  on_trip:    { bg: 'rgba(96,165,250,.12)', text: '#60a5fa', dot: '#60a5fa' },
  in_shop:    { bg: 'rgba(245,158,11,.12)', text: '#f59e0b', dot: '#f59e0b' },
  retired:    { bg: 'rgba(82,82,91,.2)',    text: '#71717a', dot: '#52525b' },
  off_duty:   { bg: 'rgba(82,82,91,.2)',    text: '#71717a', dot: '#52525b' },
  suspended:  { bg: 'rgba(239,68,68,.12)', text: '#ef4444', dot: '#ef4444' },
  draft:      { bg: 'rgba(82,82,91,.2)',    text: '#71717a', dot: '#52525b' },
  dispatched: { bg: 'rgba(96,165,250,.12)', text: '#60a5fa', dot: '#60a5fa' },
  completed:  { bg: 'rgba(34,197,94,.12)',  text: '#22c55e', dot: '#22c55e' },
  cancelled:  { bg: 'rgba(239,68,68,.12)', text: '#ef4444', dot: '#ef4444' },
};

const Badge = ({ status }) => {
  const c = STATUS_COLORS[status] || { bg: '#27272a', text: '#71717a', dot: '#52525b' };
  return <span className="badge" style={{ background: c.bg, color: c.text }}>
    <span className="badge-dot" style={{ background: c.dot }} />
    {status?.replace(/_/g, ' ')}
  </span>;
};

const Spinner = () => <div className="spinner" />;
const Empty = ({ icon, msg }) => <div className="empty"><div className="empty-icon">{icon}</div><div className="empty-text">{msg}</div></div>;
const Err = ({ msg }) => msg ? <div className="error-banner">‚ö† {msg}</div> : null;

const Field = ({ label, children, required }) => (
  <div className="form-field">
    <label className="form-label">{label}{required && <span style={{color:'#f59e0b',marginLeft:3}}>*</span>}</label>
    {children}
  </div>
);

const Modal = ({ title, onClose, children, wide }) => (
  <div className="modal-overlay" onClick={e => e.target === e.currentTarget && onClose()}>
    <div className={`modal ${wide ? 'modal-wide' : ''}`}>
      <div className="modal-header">
        <span className="modal-title">{title}</span>
        <button className="modal-close" onClick={onClose}>√ó</button>
      </div>
      <div className="modal-body">{children}</div>
    </div>
  </div>
);

const Confirm = ({ title, msg, onOk, onCancel, danger }) => (
  <Modal title={title} onClose={onCancel}>
    <div className="confirm-msg"><span>‚ö†</span><span>{msg}</span></div>
    <div className="btn-row">
      <button className="btn btn-ghost" onClick={onCancel}>Cancel</button>
      <button className={`btn ${danger ? 'btn-danger' : 'btn-primary'}`} onClick={onOk}>Confirm</button>
    </div>
  </Modal>
);

// ‚îÄ‚îÄ‚îÄ AUTH CONTEXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const AuthCtx = createContext(null);
const useAuth = () => useContext(AuthCtx);

// ‚îÄ‚îÄ‚îÄ LOGIN PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LoginPage = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [pw, setPw] = useState('');
  const [show, setShow] = useState(false);
  const [err, setErr] = useState('');
  const [loading, setLoading] = useState(false);

  const submit = async (e) => {
    e.preventDefault(); setErr(''); setLoading(true);
    try {
      const r = await api.login(email, pw);
      localStorage.setItem('ff_token', r.access_token);
      const me = await api.me();
      onLogin(me);
    } catch(e) { setErr(e.message); }
    finally { setLoading(false); }
  };

  return (
    <div className="login-wrap">
      <div className="login-left">
        <div className="login-grid" />
        <div style={{position:'relative',zIndex:1,display:'flex',alignItems:'center',gap:10}}>
          <div className="logo-icon">üöõ</div>
          <span className="logo-text">FLEETFLOW</span>
        </div>
        <div style={{position:'relative',zIndex:1}}>
          <div className="login-big">FLEET<br/>MANAGE<br/>MENT</div>
          <div className="login-desc">Real-time visibility across your entire fleet. Vehicles, drivers, trips, fuel, and expenses ‚Äî unified.</div>
        </div>
        <div style={{position:'relative',zIndex:1}} className="login-stats">
          {[['‚àû','Vehicles','Tracked'],['‚àû','Drivers','Managed'],['‚àû','Trips','Dispatched']].map(([n,a,b]) => (
            <div key={a}>
              <div className="login-stat-num">{n}</div>
              <div className="login-stat-lbl">{b}</div>
              <div className="login-stat-lbl">{a}</div>
            </div>
          ))}
        </div>
      </div>
      <div className="login-right">
        <div className="login-form-wrap">
          <div className="login-title">SIGN IN</div>
          <div className="login-sub">Enter your credentials to access the dashboard.</div>
          <Err msg={err} />
          <form onSubmit={submit}>
            <Field label="Email" required>
              <input className="input" type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@company.com" required autoFocus />
            </Field>
            <div style={{marginTop:12}}>
              <Field label="Password" required>
                <div style={{position:'relative'}}>
                  <input className="input" type={show?'text':'password'} value={pw} onChange={e=>setPw(e.target.value)} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required style={{paddingRight:36}} />
                  <button type="button" onClick={()=>setShow(!show)} style={{position:'absolute',right:10,top:'50%',transform:'translateY(-50%)',background:'none',border:'none',color:'#71717a',cursor:'pointer',fontSize:14}}>
                    {show?'üôà':'üëÅ'}
                  </button>
                </div>
              </Field>
            </div>
            <button type="submit" className="btn btn-primary" disabled={loading} style={{width:'100%',justifyContent:'center',marginTop:20,padding:'10px 16px'}}>
              {loading ? 'Signing in‚Ä¶' : 'Sign In ‚Üí'}
            </button>
          </form>
        </div>
      </div>
    </div>
  );
};

// ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const Dashboard = ({ navigate }) => {
  const [data, setData] = useState(null);

  useEffect(() => {
    Promise.all([
      api.vehicles({ limit: 200 }),
      api.drivers({ limit: 200 }),
      api.trips({ limit: 20 }),
      api.maintenance({ is_active: true }),
      api.expiringLicenses(30).catch(() => []),
    ]).then(([v, d, t, m, el]) => setData({ vehicles: v, drivers: d, trips: t, maintenance: m, expiring: el }));
  }, []);

  if (!data) return <Spinner />;
  const { vehicles, drivers, trips, maintenance, expiring } = data;

  const vStatus = ['available','on_trip','in_shop','retired'];
  const vCounts = vStatus.map(s => ({ s, n: vehicles.filter(v => v.status === s).length }));
  const maxV = Math.max(...vCounts.map(x => x.n), 1);
  const statusBar = { available: '#22c55e', on_trip: '#60a5fa', in_shop: '#f59e0b', retired: '#52525b' };

  const alerts = [
    ...expiring.map(d => ({ type: 'warn', msg: `${d.full_name}'s license expires ${fmt.date(d.license_expiry_date)}` })),
    ...maintenance.map(m => ({ type: 'info', msg: `Vehicle in shop: ${m.service_type} since ${fmt.date(m.start_date)}` })),
  ];

  return (
    <div>
      <div className="page-header">
        <div>
          <div className="page-title">DASHBOARD</div>
          <div className="page-sub">Fleet overview at a glance</div>
        </div>
      </div>

      <div className="stats-grid">
        <div className="stat-card">
          <div className="stat-label">Total Vehicles</div>
          <div className="stat-value" style={{color:'#f59e0b'}}>{vehicles.length}</div>
          <div className="stat-sub">{vehicles.filter(v=>v.status==='available').length} available now</div>
        </div>
        <div className="stat-card">
          <div className="stat-label">Drivers</div>
          <div className="stat-value" style={{color:'#60a5fa'}}>{drivers.length}</div>
          <div className="stat-sub">{drivers.filter(d=>d.status==='available').length} available</div>
        </div>
        <div className="stat-card">
          <div className="stat-label">Active Trips</div>
          <div className="stat-value" style={{color:'#22c55e'}}>{trips.filter(t=>t.status==='dispatched').length}</div>
          <div className="stat-sub">currently dispatched</div>
        </div>
        <div className="stat-card">
          <div className="stat-label">In Maintenance</div>
          <div className="stat-value" style={{color:'#ef4444'}}>{maintenance.length}</div>
          <div className="stat-sub">vehicles in shop</div>
        </div>
      </div>

      <div className="charts-row">
        <div className="chart-card">
          <div className="chart-title">Vehicle Status</div>
          <div className="mini-bars">
            {vCounts.map(({ s, n }) => (
              <div key={s} className="mini-bar-wrap">
                <div className="mini-bar-val">{n}</div>
                <div className="mini-bar" style={{ height: `${Math.max((n / maxV) * 70, 4)}px`, background: statusBar[s] }} />
                <div className="mini-bar-label">{s.replace(/_/g,' ')}</div>
              </div>
            ))}
          </div>
        </div>

        <div className="chart-card">
          <div className="chart-title">Alerts & Notifications</div>
          {alerts.length === 0
            ? <div className="alert-item">‚úÖ No alerts ‚Äî everything looks good</div>
            : alerts.map((a,i) => (
              <div key={i} className="alert-item">
                <span>{a.type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                <span>{a.msg}</span>
              </div>
            ))
          }
        </div>
      </div>

      <div className="table-wrap">
        <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'14px 16px',borderBottom:'1px solid var(--border)'}}>
          <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:10,letterSpacing:'.12em',textTransform:'uppercase',color:'var(--subtle)'}}>Recent Trips</span>
          <button className="btn btn-ghost btn-sm" onClick={()=>navigate('trips')}>View all ‚Üí</button>
        </div>
        {trips.length === 0 ? <Empty icon="üõ£" msg="No trips yet" /> :
          <table><thead><tr><th>Route</th><th>Status</th><th>Cargo</th><th>Scheduled</th></tr></thead>
          <tbody>{trips.slice(0,8).map(t=>(
            <tr key={t.id}>
              <td><span className="td-main">{t.origin} ‚Üí {t.destination}</span></td>
              <td><Badge status={t.status}/></td>
              <td><span className="td-mono">{t.cargo_weight_kg} kg</span></td>
              <td><span className="td-mono">{fmt.datetime(t.scheduled_at)}</span></td>
            </tr>
          ))}</tbody></table>
        }
      </div>
    </div>
  );
};

// ‚îÄ‚îÄ‚îÄ VEHICLES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const VehicleForm = ({ initial, onSubmit, onClose, loading, err }) => {
  const [f, setF] = useState(initial || { name:'',license_plate:'',vehicle_type:'truck',max_capacity_kg:'',make:'',model:'',year:'',region:'',notes:'' });
  const s = (k,v) => setF(p=>({...p,[k]:v}));
  return (
    <form onSubmit={e=>{e.preventDefault();onSubmit(f);}}>
      <Err msg={err}/>
      <div className="form-grid">
        <Field label="Name" required><input className="input" value={f.name} onChange={e=>s('name',e.target.value)} required/></Field>
        <Field label="License Plate" required><input className="input" value={f.license_plate} onChange={e=>s('license_plate',e.target.value)} required/></Field>
        <Field label="Type" required>
          <select className="input" value={f.vehicle_type} onChange={e=>s('vehicle_type',e.target.value)}>
            {['truck','van','car','motorcycle','heavy_equipment'].map(t=><option key={t} value={t}>{t.replace(/_/g,' ')}</option>)}
          </select>
        </Field>
        <Field label="Max Capacity (kg)" required><input className="input" type="number" min="1" value={f.max_capacity_kg} onChange={e=>s('max_capacity_kg',e.target.value)} required/></Field>
        <Field label="Make"><input className="input" value={f.make} onChange={e=>s('make',e.target.value)}/></Field>
        <Field label="Model"><input className="input" value={f.model} onChange={e=>s('model',e.target.value)}/></Field>
        <Field label="Year"><input className="input" type="number" min="1990" max="2100" value={f.year} onChange={e=>s('year',e.target.value)}/></Field>
        <Field label="Region"><input className="input" value={f.region} onChange={e=>s('region',e.target.value)}/></Field>
      </div>
      <div style={{marginTop:14}}><Field label="Notes"><textarea className="input" rows={2} value={f.notes} onChange={e=>s('notes',e.target.value)}/></Field></div>
      <div className="btn-row" style={{marginTop:18}}>
        <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
        <button type="submit" className="btn btn-primary" disabled={loading}>{loading?'Saving‚Ä¶':'Save Vehicle'}</button>
      </div>
    </form>
  );
};

const VehiclesPage = () => {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('');
  const [modal, setModal] = useState(null);
  const [fLoading, setFLoading] = useState(false);
  const [fErr, setFErr] = useState('');
  const [retireTarget, setRetireTarget] = useState(null);

  const load = useCallback(() => {
    setLoading(true);
    api.vehicles({ status: filter||undefined, limit:200 }).then(setRows).finally(()=>setLoading(false));
  }, [filter]);
  useEffect(()=>{ load(); }, [load]);

  const create = async (f) => {
    setFErr(''); setFLoading(true);
    try { await api.createVehicle({...f, max_capacity_kg:Number(f.max_capacity_kg), year:f.year?Number(f.year):undefined}); setModal(null); load(); }
    catch(e){ setFErr(e.message); } finally{ setFLoading(false); }
  };
  const update = async (f) => {
    setFErr(''); setFLoading(true);
    try { await api.updateVehicle(modal.id, f); setModal(null); load(); }
    catch(e){ setFErr(e.message); } finally{ setFLoading(false); }
  };
  const retire = async () => {
    await api.retireVehicle(retireTarget.id).catch(()=>{});
    setRetireTarget(null); load();
  };

  return (
    <div>
      <div className="page-header">
        <div><div className="page-title">VEHICLES</div><div className="page-sub">{rows.length} total</div></div>
        <button className="btn btn-primary" onClick={()=>{setFErr('');setModal('new')}}>Ôºã Add Vehicle</button>
      </div>
      <div className="filter-bar">
        <select className="input input-auto" value={filter} onChange={e=>setFilter(e.target.value)}>
          <option value="">All statuses</option>
          {['available','on_trip','in_shop','retired'].map(s=><option key={s} value={s}>{s.replace(/_/g,' ')}</option>)}
        </select>
        <button className="btn btn-ghost btn-sm" onClick={load}>‚Ü∫ Refresh</button>
      </div>
      <div className="table-wrap">
        {loading ? <Spinner/> : rows.length===0 ? <Empty icon="üöõ" msg="No vehicles found"/> :
          <table><thead><tr><th>Vehicle</th><th>Type</th><th>Plate</th><th>Capacity</th><th>Odometer</th><th>Status</th><th>Region</th><th></th></tr></thead>
          <tbody>{rows.map(v=>(
            <tr key={v.id}>
              <td><div className="td-main">{v.name}</div><div className="td-sub">{[v.year,v.make,v.model].filter(Boolean).join(' ')}</div></td>
              <td><span className="td-mono">{v.vehicle_type}</span></td>
              <td><span className="td-amber">{v.license_plate}</span></td>
              <td><span className="td-mono">{fmt.num(v.max_capacity_kg,'kg')}</span></td>
              <td><span className="td-mono">{fmt.num(v.odometer_km,'km')}</span></td>
              <td><Badge status={v.status}/></td>
              <td><span className="td-mono">{v.region||'‚Äî'}</span></td>
              <td>
                <div style={{display:'flex',gap:6}}>
                  <button className="btn btn-ghost btn-sm" onClick={()=>{setFErr('');setModal(v)}}>Edit</button>
                  {v.status!=='retired'&&<button className="btn btn-danger btn-sm" onClick={()=>setRetireTarget(v)}>Retire</button>}
                </div>
              </td>
            </tr>
          ))}</tbody></table>
        }
      </div>
      {modal==='new'&&<Modal title="Add Vehicle" onClose={()=>setModal(null)} wide><VehicleForm onSubmit={create} onClose={()=>setModal(null)} loading={fLoading} err={fErr}/></Modal>}
      {modal&&modal!=='new'&&<Modal title="Edit Vehicle" onClose={()=>setModal(null)} wide><VehicleForm initial={modal} onSubmit={update} onClose={()=>setModal(null)} loading={fLoading} err={fErr}/></Modal>}
      {retireTarget&&<Confirm title="Retire Vehicle" msg={`Retire "${retireTarget.name}"? Status will be set to retired.`} onOk={retire} onCancel={()=>setRetireTarget(null)} danger/>}
    </div>
  );
};

// ‚îÄ‚îÄ‚îÄ DRIVERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DriverForm = ({ initial, onSubmit, onClose, loading, err }) => {
  const [f, setF] = useState(initial || { full_name:'',license_number:'',license_category:'',license_expiry_date:'',employee_id:'',phone:'',email:'',notes:'' });
  const s = (k,v) => setF(p=>({...p,[k]:v}));
  return (
    <form onSubmit={e=>{e.preventDefault();onSubmit(f);}}>
      <Err msg={err}/>
      <div className="form-grid">
        <Field label="Full Name" required><input className="input" value={f.full_name} onChange={e=>s('full_name',e.target.value)} required/></Field>
        <Field label="Employee ID"><input className="input" value={f.employee_id} onChange={e=>s('employee_id',e.target.value)}/></Field>
        <Field label="License Number" required><input className="input" value={f.license_number} onChange={e=>s('license_number',e.target.value)} required/></Field>
        <Field label="License Category" required><input className="input" placeholder="e.g. CDL-A" value={f.license_category} onChange={e=>s('license_category',e.target.value)} required/></Field>
        <Field label="License Expiry" required><input className="input" type="date" value={f.license_expiry_date} onChange={e=>s('license_expiry_date',e.target.value)} required/></Field>
        <Field label="Phone"><input className="input" value={f.phone} onChange={e=>s('phone',e.target.value)}/></Field>
        <Field label="Email"><input className="input" type="email" value={f.email} onChange={e=>s('email',e.target.value)}/></Field>
        {initial&&<Field label="Safety Score (0-100)"><input className="input" type="number" min="0" max="100" value={f.safety_score||''} onChange={e=>s('safety_score',e.target.value)}/></Field>}
      </div>
      <div style={{marginTop:14}}><Field label="Notes"><textarea className="input" rows={2} value={f.notes} onChange={e=>s('notes',e.target.value)}/></Field></div>
      <div className="btn-row" style={{marginTop:18}}>
        <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
        <button type="submit" className="btn btn-primary" disabled={loading}>{loading?'Saving‚Ä¶':'Save Driver'}</button>
      </div>
    </form>
  );
};

const DriversPage = () => {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('');
  const [modal, setModal] = useState(null);
  const [fLoading, setFLoading] = useState(false);
  const [fErr, setFErr] = useState('');

  const load = useCallback(() => {
    setLoading(true);
    api.drivers({ status:filter||undefined, limit:200 }).then(setRows).finally(()=>setLoading(false));
  }, [filter]);
  useEffect(()=>{ load(); }, [load]);

  const create = async (f) => {
    setFErr(''); setFLoading(true);
    try { await api.createDriver(f); setModal(null); load(); }
    catch(e){ setFErr(e.message); } finally{ setFLoading(false); }
  };
  const update = async (f) => {
    setFErr(''); setFLoading(true);
    try { const p={...f}; if(p.safety_score) p.safety_score=Number(p.safety_score); await api.updateDriver(modal.id,p); setModal(null); load(); }
    catch(e){ setFErr(e.message); } finally{ setFLoading(false); }
  };

  const expiring = (d) => { const diff=(new Date(d)-new Date())/(864e5); return diff<=30; };
  const scoreClass = (s) => s>=80?'score-high':s>=50?'score-mid':'score-low';

  return (
    <div>
      <div className="page-header">
        <div><div className="page-title">DRIVERS</div><div className="page-sub">{rows.length} total</div></div>
        <button className="btn btn-primary" onClick={()=>{setFErr('');setModal('new')}}>Ôºã Add Driver</button>
      </div>
      <div className="filter-bar">
        <select className="input input-auto" value={filter} onChange={e=>setFilter(e.target.value)}>
          <option value="">All statuses</option>
          {['available','on_trip','off_duty','suspended'].map(s=><option key={s} value={s}>{s.replace(/_/g,' ')}</option>)}
        </select>
        <button className="btn btn-ghost btn-sm" onClick={load}>‚Ü∫ Refresh</button>
      </div>
      <div className="table-wrap">
        {loading?<Spinner/>:rows.length===0?<Empty icon="üë§" msg="No drivers found"/>:
          <table><thead><tr><th>Driver</th><th>License</th><th>Category</th><th>Expiry</th><th>Safety</th><th>Trips</th><th>Status</th><th></th></tr></thead>
          <tbody>{rows.map(d=>(
            <tr key={d.id}>
              <td><div className="td-main">{d.full_name}</div><div className="td-sub">{d.employee_id||d.email||d.phone||''}</div></td>
              <td><span className="td-amber">{d.license_number}</span></td>
              <td><span className="td-mono">{d.license_category}</span></td>
              <td><span className="td-mono" style={expiring(d.license_expiry_date)?{color:'#f59e0b'}:{}}>{expiring(d.license_expiry_date)?'‚ö† ':''}{fmt.date(d.license_expiry_date)}</span></td>
              <td>{d.safety_score!=null?<span className={scoreClass(d.safety_score)}>{d.safety_score}/100</span>:<span className="td-mono">‚Äî</span>}</td>
              <td><span className="td-mono">{d.trips_completed}/{d.trips_total}</span></td>
              <td><Badge status={d.status}/></td>
              <td><button className="btn btn-ghost btn-sm" onClick={()=>{setFErr('');setModal(d)}}>Edit</button></td>
            </tr>
          ))}</tbody></table>
        }
      </div>
      {modal==='new'&&<Modal title="Add Driver" onClose={()=>setModal(null)} wide><DriverForm onSubmit={create} onClose={()=>setModal(null)} loading={fLoading} err={fErr}/></Modal>}
      {modal&&modal!=='new'&&<Modal title="Edit Driver" onClose={()=>setModal(null)} wide><DriverForm initial={{...modal,license_expiry_date:modal.license_expiry_date?.split('T')[0]||modal.license_expiry_date}} onSubmit={update} onClose={()=>setModal(null)} loading={fLoading} err={fErr}/></Modal>}
    </div>
  );
};

// ‚îÄ‚îÄ‚îÄ TRIPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TripForm = ({ onSubmit, onClose, loading, err }) => {
  const [f, setF] = useState({ vehicle_id:'',driver_id:'',origin:'',destination:'',cargo_weight_kg:'',cargo_description:'',scheduled_at:'',notes:'' });
  const [vehicles, setVehicles] = useState([]);
  const [drivers, setDrivers] = useState([]);
  const s = (k,v) => setF(p=>({...p,[k]:v}));
  useEffect(()=>{ api.vehiclesAvail().then(setVehicles); api.driversAvail().then(setDrivers); },[]);
  return (
    <form onSubmit={e=>{e.preventDefault();onSubmit({...f,cargo_weight_kg:Number(f.cargo_weight_kg)});}}>
      <Err msg={err}/>
      <div className="form-grid">
        <Field label="Vehicle" required>
          <select className="input" value={f.vehicle_id} onChange={e=>s('vehicle_id',e.target.value)} required>
            <option value="">Select vehicle‚Ä¶</option>
            {vehicles.map(v=><option key={v.id} value={v.id}>{v.name} ‚Äî {v.license_plate}</option>)}
          </select>
        </Field>
        <Field label="Driver" required>
          <select className="input" value={f.driver_id} onChange={e=>s('driver_id',e.target.value)} required>
            <option value="">Select driver‚Ä¶</option>
            {drivers.map(d=><option key={d.id} value={d.id}>{d.full_name}</option>)}
          </select>
        </Field>
        <Field label="Origin" required><input className="input" placeholder="City / Address" value={f.origin} onChange={e=>s('origin',e.target.value)} required/></Field>
        <Field label="Destination" required><input className="input" placeholder="City / Address" value={f.destination} onChange={e=>s('destination',e.target.value)} required/></Field>
        <Field label="Cargo Weight (kg)" required><input className="input" type="number" min="0" value={f.cargo_weight_kg} onChange={e=>s('cargo_weight_kg',e.target.value)} required/></Field>
        <Field label="Scheduled At"><input className="input" type="datetime-local" value={f.scheduled_at} onChange={e=>s('scheduled_at',e.target.value)}/></Field>
        <Field label="Cargo Description"><input className="input" value={f.cargo_description} onChange={e=>s('cargo_description',e.target.value)}/></Field>
      </div>
      <div style={{marginTop:14}}><Field label="Notes"><textarea className="input" rows={2} value={f.notes} onChange={e=>s('notes',e.target.value)}/></Field></div>
      <div className="btn-row" style={{marginTop:18}}>
        <button type="button" className="btn btn-ghost" onClick={onClose}>Cancel</button>
        <button type="submit" className="btn btn-primary" disabled={loading}>{loading?'Creating‚Ä¶':'Create Trip'}</button>
      </div>
    </form>
  );
};

const TripsPage = () => {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('');
  const [modal, setModal] = useState(null);
  const [confirm, setConfirm] = useState(null);
  const [cancelReason, setCancelReason] = useState('');
  const [fLoading, setFLoading] = useState(false);
  const [fErr, setFErr] = useState('');

  const load = useCallback(() => {
    setLoading(true);
    api.trips({ status:filter||undefined, limit:200 }).then(setRows).finally(()=>setLoading(false));
  }, [filter]);
  useEffect(()=>{ load(); }, [load]);

  const create = async (f) => {
    setFErr(''); setFLoading(true);
    try { await api.createTrip(f); setModal(null); load(); }
    catch(e){ setFErr(e.message); } finally{ setFLoading(false); }
  };

  return (
    <div>
      <div className="page-header">
        <div><div className="page-title">TRIPS</div><div className="page-sub">{rows.length} total</div></div>
        <button className="btn btn-primary" onClick={()=>{setFErr('');setModal('new')}}>Ôºã New Trip</button>
      </div>
      <div className="filter-bar">
        <select className="input input-auto" value={filter} onChange={e=>setFilter(e.target.value)}>
          <option value="">All statuses</option>
          {['draft','dispatched','completed','cancelled'].map(s=><option key={s} value={s}>{s}</option>)}
        </select>
        <button className="btn btn-ghost btn-sm" onClick={load}>‚Ü∫ Refresh</button>
      </div>
      <div className="table-wrap">
        {loading?<Spinner/>:rows.length===0?<Empty icon="üõ£" msg="No trips found"/>:
          <table><thead><tr><th>Route</th><th>Cargo</th><th>Status</th><th>Scheduled</th><th>Dist.</th><th>Actions</th></tr></thead>
          <tbody>{rows.map(t=>(
            <tr key={t.id}>
              <td><div className="td-main">{t.origin} ‚Üí {t.destination}</div>{t.cargo_description&&<div className="td-sub">{t.cargo_description}</div>}</td>
              <td><span className="td-mono">{t.cargo_weight_kg} kg</span></td>
              <td><Badge status={t.status}/></td>
              <td><span className="td-mono">{fmt.datetime(t.scheduled_at)}</span></td>
              <td><span className="td-mono">{t.distance_km!=null?`${t.distance_km} km`:'‚Äî'}</span></td>
              <td>
                <div style={{display:'flex',gap:5}}>
                  {t.status==='draft'&&<button className="btn btn-blue btn-sm" onClick={()=>setConfirm({type:'dispatch',trip:t})}>üöõ Dispatch</button>}
                  {t.status==='dispatched'&&<button className="btn btn-green btn-sm" onClick={()=>setConfirm({type:'complete',trip:t})}>‚úì Complete</button>}
                  {(t.status==='draft'||t.status==='dispatched')&&<button className="btn btn-danger btn-sm" onClick={()=>{setCancelReason('');setConfirm({type:'cancel',trip:t})}}>‚úï Cancel</button>}
                </div>
              </td>
            </tr>
          ))}</tbody></table>
        }
      </div>
      {modal==='new'&&<Modal title="New Trip" onClose={()=>setModal(null)} wide><TripForm onSubmit={create} onClose={()=>setModal(null)} loading={fLoading} err={fErr}/></Modal>}
      {confirm?.type==='dispatch'&&<Confirm title="Dispatch Trip" msg={`Dispatch ${confirm.trip.origin} ‚Üí ${confirm.trip.destination}? Vehicle and driver will be set to On Trip.`} onOk={async()=>{await api.dispatchTrip(confirm.trip.id).catch(()=>{});setConfirm(null);load();}} onCancel={()=>setConfirm(null)}/>}
      {confirm?.type==='complete'&&<Confirm title="Complete Trip" msg={`Mark ${confirm.trip.origin} ‚Üí ${confirm.trip.destination} as completed? This frees the vehicle and driver.`} onOk={async()=>{await api.completeTrip(confirm.trip.id).catch(()=>{});setConfirm(null);load();}} onCancel={()=>setConfirm(null)}/>}
      {confirm?.type==='cancel'&&(
        <Modal title="Cancel Trip" onClose={()=>setConfirm(null)}>
          <p style={{fontSize:13,color:'var(--subtle)',marginBottom:14}}>Provide a reason for cancellation (optional).</p>
          <textarea className="input" rows={3} placeholder="Reason‚Ä¶" value={cancelReason} onChange={e=>setCancelReason(e.target.value)} style={{marginBottom:14}}/>
          <div className="btn-row">
            <button className="btn btn-ghost" onClick={()=>setConfirm(null)}>Back</button>
            <button className="btn btn-danger" onClick={async()=>{await api.cancelTrip(confirm.trip.id,cancelReason).catch(()=>{});setConfirm(null);load();}}>Cancel Trip</button>
          </div>
        </Modal>
      )}
    </div>
  );
};

// ‚îÄ‚îÄ‚îÄ FUEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FuelPage = () => {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [modal, setModal] = useState(false);
  const [fLoading, setFLoading] = useState(false);
  const [fErr, setFErr] = useState('');
  const [vehicles, setVehicles] = useState([]);
  const [f, setF] = useState({ vehicle_id:'',liters:'',cost_per_liter:'',fuel_date:new Date().toISOString().split('T')[0],station_name:'',odometer_at_fill:'',notes:'' });
  const s = (k,v) => setF(p=>({...p,[k]:v}));

  const load = () => { setLoading(true); api.fuel({ limit:200 }).then(setRows).finally(()=>setLoading(false)); };
  useEffect(()=>{ load(); api.vehicles({limit:200}).then(setVehicles); },[]);

  const total = f.liters&&f.cost_per_liter ? (Number(f.liters)*Number(f.cost_per_liter)).toFixed(2) : null;
  const totalCost = rows.reduce((s,r)=>s+(r.total_cost||r.liters*r.cost_per_liter),0);
  const totalLiters = rows.reduce((s,r)=>s+r.liters,0);

  const create = async (e) => {
    e.preventDefault(); setFErr(''); setFLoading(true);
    try { await api.createFuel({...f,liters:Number(f.liters),cost_per_liter:Number(f.cost_per_liter),odometer_at_fill:f.odometer_at_fill?Number(f.odometer_at_fill):undefined}); setModal(false); load(); }
    catch(e){ setFErr(e.message); } finally{ setFLoading(false); }
  };

  return (
    <div>
      <div className="page-header">
        <div><div className="page-title">FUEL LOGS</div><div className="page-sub">{rows.length} entries</div></div>
        <button className="btn btn-primary" onClick={()=>{setFErr('');setModal(true)}}>Ôºã Log Fuel</button>
      </div>
      <div className="stats-grid" style={{gridTemplateColumns:'repeat(3,1fr)'}}>
        <div className="stat-card"><div className="stat-label">Total Entries</div><div className="stat-value">{rows.length}</div></div>
        <div className="stat-card"><div className="stat-label">Total Liters</div><div className="stat-value" style={{color:'#f59e0b'}}>{totalLiters.toFixed(0)}</div></div>
        <div className="stat-card"><div className="stat-label">Total Spent</div><div className="stat-value" style={{color:'#e5e5e5'}}>{fmt.currency(totalCost)}</div></div>
      </div>
      <div className="table-wrap">
        {loading?<Spinner/>:rows.length===0?<Empty icon="‚õΩ" msg="No fuel logs yet"/>:
          <table><thead><tr><th>Date</th><th>Vehicle</th><th>Liters</th><th>Cost/L</th><th>Total</th><th>Odometer</th><th>Station</th></tr></thead>
          <tbody>{rows.map(r=>(
            <tr key={r.id}>
              <td><span className="td-mono">{fmt.date(r.fuel_date)}</span></td>
              <td><span className="td-amber">{r.vehicle_id?.slice(0,8)}‚Ä¶</span></td>
              <td><span className="td-mono">{r.liters} L</span></td>
              <td><span className="td-mono">${r.cost_per_liter}</span></td>
              <td><span className="td-mono" style={{color:'var(--text)',fontWeight:500}}>{fmt.currency(r.total_cost||r.liters*r.cost_per_liter)}</span></td>
              <td><span className="td-mono">{r.odometer_at_fill?`${r.odometer_at_fill} km`:'‚Äî'}</span></td>
              <td><span style={{fontSize:12,color:'var(--subtle)'}}>{r.station_name||'‚Äî'}</span></td>
            </tr>
          ))}</tbody></table>
        }
      </div>
      {modal&&(
        <Modal title="Log Fuel" onClose={()=>setModal(false)} wide>
          <form onSubmit={create}>
            <Err msg={fErr}/>
            <div className="form-grid">
              <Field label="Vehicle" required>
                <select className="input" value={f.vehicle_id} onChange={e=>s('vehicle_id',e.target.value)} required>
                  <option value="">Select vehicle‚Ä¶</option>
                  {vehicles.map(v=><option key={v.id} value={v.id}>{v.name} ‚Äî {v.license_plate}</option>)}
                </select>
              </Field>
              <Field label="Date" required><input className="input" type="date" value={f.fuel_date} onChange={e=>s('fuel_date',e.target.value)} required/></Field>
              <Field label="Liters" required><input className="input" type="number" step="0.01" min="0.01" value={f.liters} onChange={e=>s('liters',e.target.value)} required/></Field>
              <Field label="Cost per Liter" required><input className="input" type="number" step="0.001" min="0.01" value={f.cost_per_liter} onChange={e=>s('cost_per_liter',e.target.value)} required/></Field>
              <Field label="Odometer (km)"><input className="input" type="number" value={f.odometer_at_fill} onChange={e=>s('odometer_at_fill',e.target.value)}/></Field>
              <Field label="Station"><input className="input" value={f.station_name} onChange={e=>s('station_name',e.target.value)}/></Field>
            </div>
            {total&&<div className="total-highlight" style={{marginTop:14}}><span className="total-label">Total Cost</span><span className="total-value">${total}</span></div>}
            <div className="btn-row" style={{marginTop:18}}>
              <button type="button" className="btn btn-ghost" onClick={()=>setModal(false)}>Cancel</button>
              <button type="submit" className="btn btn-primary" disabled={fLoading}>{fLoading?'Saving‚Ä¶':'Log Fuel'}</button>
            </div>
          </form>
        </Modal>
      )}
    </div>
  );
};

// ‚îÄ‚îÄ‚îÄ MAINTENANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MaintenancePage = () => {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filterActive, setFilterActive] = useState('');
  const [modal, setModal] = useState(false);
  const [fLoading, setFLoading] = useState(false);
  const [fErr, setFErr] = useState('');
  const [vehicles, setVehicles] = useState([]);
  const [completeTarget, setCompleteTarget] = useState(null);
  const [f, setF] = useState({ vehicle_id:'',service_type:'',start_date:new Date().toISOString().split('T')[0],cost:'0',description:'',end_date:'',vendor_name:'',odometer_at_service:'' });
  const s = (k,v) => setF(p=>({...p,[k]:v}));

  const load = useCallback(() => {
    setLoading(true);
    api.maintenance({ is_active:filterActive===''?undefined:filterActive==='true', limit:200 }).then(setRows).finally(()=>setLoading(false));
  }, [filterActive]);
  useEffect(()=>{ load(); api.vehicles({limit:200}).then(setVehicles); },[load]);

  const create = async (e) => {
    e.preventDefault(); setFErr(''); setFLoading(true);
    try { await api.createMaintenance({...f,cost:Number(f.cost),odometer_at_service:f.odometer_at_service?Number(f.odometer_at_service):undefined,end_date:f.end_date||undefined}); setModal(false); load(); }
    catch(e){ setFErr(e.message); } finally{ setFLoading(false); }
  };

  const totalCost = rows.reduce((s,r)=>s+r.cost,0);
  const active = rows.filter(r=>r.is_active).length;

  return (
    <div>
      <div className="page-header">
        <div><div className="page-title">MAINTENANCE</div><div className="page-sub">{active} active, {rows.length-active} completed</div></div>
        <button className="btn btn-primary" onClick={()=>{setFErr('');setModal(true)}}>Ôºã New Log</button>
      </div>
      <div className="stats-grid" style={{gridTemplateColumns:'repeat(3,1fr)'}}>
        <div className="stat-card"><div className="stat-label">Active Jobs</div><div className="stat-value" style={{color:'#f59e0b'}}>{active}</div></div>
        <div className="stat-card"><div className="stat-label">Completed</div><div className="stat-value">{rows.length-active}</div></div>
        <div className="stat-card"><div className="stat-label">Total Cost</div><div className="stat-value">{fmt.currency(totalCost)}</div></div>
      </div>
      <div className="filter-bar">
        <select className="input input-auto" value={filterActive} onChange={e=>setFilterActive(e.target.value)}>
          <option value="">All</option><option value="true">Active</option><option value="false">Completed</option>
        </select>
        <button className="btn btn-ghost btn-sm" onClick={load}>‚Ü∫ Refresh</button>
      </div>
      <div className="table-wrap">
        {loading?<Spinner/>:rows.length===0?<Empty icon="üîß" msg="No maintenance logs"/>:
          <table><thead><tr><th>Service</th><th>Start</th><th>End</th><th>Cost</th><th>Vendor</th><th>Status</th><th></th></tr></thead>
          <tbody>{rows.map(r=>(
            <tr key={r.id}>
              <td><div className="td-main">{r.service_type}</div>{r.description&&<div className="td-sub">{r.description}</div>}</td>
              <td><span className="td-mono">{fmt.date(r.start_date)}</span></td>
              <td><span className="td-mono">{r.end_date?fmt.date(r.end_date):'‚Äî'}</span></td>
              <td><span className="td-mono">{fmt.currency(r.cost)}</span></td>
              <td><span style={{fontSize:12,color:'var(--subtle)'}}>{r.vendor_name||'‚Äî'}</span></td>
              <td><span className="badge" style={{background:r.is_active?'rgba(245,158,11,.12)':'rgba(34,197,94,.12)',color:r.is_active?'#f59e0b':'#22c55e'}}>
                <span className="badge-dot" style={{background:r.is_active?'#f59e0b':'#22c55e'}}/>
                {r.is_active?'In Progress':'Completed'}
              </span></td>
              <td>{r.is_active&&<button className="btn btn-green btn-sm" onClick={()=>setCompleteTarget(r)}>‚úì Done</button>}</td>
            </tr>
          ))}</tbody></table>
        }
      </div>
      {modal&&(
        <Modal title="New Maintenance Log" onClose={()=>setModal(false)} wide>
          <form onSubmit={create}>
            <Err msg={fErr}/>
            <div className="form-grid">
              <Field label="Vehicle" required>
                <select className="input" value={f.vehicle_id} onChange={e=>s('vehicle_id',e.target.value)} required>
                  <option value="">Select vehicle‚Ä¶</option>
                  {vehicles.map(v=><option key={v.id} value={v.id}>{v.name} ‚Äî {v.license_plate}</option>)}
                </select>
              </Field>
              <Field label="Service Type" required><input className="input" placeholder="e.g. Oil Change" value={f.service_type} onChange={e=>s('service_type',e.target.value)} required/></Field>
              <Field label="Start Date" required><input className="input" type="date" value={f.start_date} onChange={e=>s('start_date',e.target.value)} required/></Field>
              <Field label="End Date"><input className="input" type="date" value={f.end_date} onChange={e=>s('end_date',e.target.value)}/></Field>
              <Field label="Cost ($)"><input className="input" type="number" step="0.01" min="0" value={f.cost} onChange={e=>s('cost',e.target.value)}/></Field>
              <Field label="Vendor"><input className="input" value={f.vendor_name} onChange={e=>s('vendor_name',e.target.value)}/></Field>
              <Field label="Odometer (km)"><input className="input" type="number" value={f.odometer_at_service} onChange={e=>s('odometer_at_service',e.target.value)}/></Field>
            </div>
            <div style={{marginTop:14}}><Field label="Description"><textarea className="input" rows={2} value={f.description} onChange={e=>s('description',e.target.value)}/></Field></div>
            <div className="btn-row" style={{marginTop:18}}>
              <button type="button" className="btn btn-ghost" onClick={()=>setModal(false)}>Cancel</button>
              <button type="submit" className="btn btn-primary" disabled={fLoading}>{fLoading?'Saving‚Ä¶':'Create Log'}</button>
            </div>
          </form>
        </Modal>
      )}
      {completeTarget&&<Confirm title="Mark Complete" msg={`Mark "${completeTarget.service_type}" as complete? Vehicle will be set back to available.`} onOk={async()=>{await api.updateMaintenance(completeTarget.id,{is_active:false}).catch(()=>{});setCompleteTarget(null);load();}} onCancel={()=>setCompleteTarget(null)}/>}
    </div>
  );
};

// ‚îÄ‚îÄ‚îÄ EXPENSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CAT_COLORS = { fuel:'#60a5fa',maintenance:'#f59e0b',insurance:'#a78bfa',toll:'#22d3ee',fine:'#ef4444',salary:'#22c55e',other:'#71717a' };

const ExpensesPage = () => {
  const [rows, setRows] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filterCat, setFilterCat] = useState('');
  const [modal, setModal] = useState(false);
  const [fLoading, setFLoading] = useState(false);
  const [fErr, setFErr] = useState('');
  const [vehicles, setVehicles] = useState([]);
  const [f, setF] = useState({ category:'other',amount:'',expense_date:new Date().toISOString().split('T')[0],vehicle_id:'',description:'',receipt_ref:'' });
  const s = (k,v) => setF(p=>({...p,[k]:v}));

  const load = useCallback(() => {
    setLoading(true);
    api.expenses({ category:filterCat||undefined, limit:200 }).then(setRows).finally(()=>setLoading(false));
  }, [filterCat]);
  useEffect(()=>{ load(); api.vehicles({limit:200}).then(setVehicles); },[load]);

  const create = async (e) => {
    e.preventDefault(); setFErr(''); setFLoading(true);
    try { await api.createExpense({...f,amount:Number(f.amount),vehicle_id:f.vehicle_id||undefined}); setModal(false); load(); }
    catch(e){ setFErr(e.message); } finally{ setFLoading(false); }
  };

  const totalAmount = rows.reduce((s,r)=>s+r.amount,0);
  const cats = ['fuel','maintenance','insurance','toll','fine','salary','other'];

  return (
    <div>
      <div className="page-header">
        <div><div className="page-title">EXPENSES</div><div className="page-sub">{rows.length} entries</div></div>
        <button className="btn btn-primary" onClick={()=>{setFErr('');setModal(true)}}>Ôºã Add Expense</button>
      </div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:14,marginBottom:28}}>
        <div className="stat-card"><div className="stat-label">Total Spent</div><div className="stat-value" style={{color:'#f59e0b'}}>{fmt.currency(totalAmount)}</div></div>
        {cats.filter(c=>rows.some(r=>r.category===c)).slice(0,3).map(c=>(
          <div key={c} className="stat-card">
            <div className="stat-label">{c}</div>
            <div className="stat-value" style={{color:CAT_COLORS[c],fontSize:32}}>{fmt.currency(rows.filter(r=>r.category===c).reduce((s,r)=>s+r.amount,0))}</div>
          </div>
        ))}
      </div>
      <div className="filter-bar">
        <select className="input input-auto" value={filterCat} onChange={e=>setFilterCat(e.target.value)}>
          <option value="">All categories</option>
          {cats.map(c=><option key={c} value={c}>{c.charAt(0).toUpperCase()+c.slice(1)}</option>)}
        </select>
        <button className="btn btn-ghost btn-sm" onClick={load}>‚Ü∫ Refresh</button>
      </div>
      <div className="table-wrap">
        {loading?<Spinner/>:rows.length===0?<Empty icon="üßæ" msg="No expenses logged"/>:
          <table><thead><tr><th>Date</th><th>Category</th><th>Amount</th><th>Description</th><th>Receipt</th></tr></thead>
          <tbody>{rows.map(r=>(
            <tr key={r.id}>
              <td><span className="td-mono">{fmt.date(r.expense_date)}</span></td>
              <td><span className="badge" style={{background:`${CAT_COLORS[r.category]}22`,color:CAT_COLORS[r.category]}}>{r.category}</span></td>
              <td><span className="td-mono" style={{color:'var(--text)',fontWeight:500,fontSize:13}}>{fmt.currency(r.amount)}</span></td>
              <td><span style={{fontSize:12,color:'var(--subtle)'}}>{r.description||'‚Äî'}</span></td>
              <td><span className="td-mono">{r.receipt_ref||'‚Äî'}</span></td>
            </tr>
          ))}</tbody></table>
        }
      </div>
      {modal&&(
        <Modal title="Add Expense" onClose={()=>setModal(false)} wide>
          <form onSubmit={create}>
            <Err msg={fErr}/>
            <div className="form-grid">
              <Field label="Category" required>
                <select className="input" value={f.category} onChange={e=>s('category',e.target.value)}>
                  {cats.map(c=><option key={c} value={c}>{c.charAt(0).toUpperCase()+c.slice(1)}</option>)}
                </select>
              </Field>
              <Field label="Amount ($)" required><input className="input" type="number" step="0.01" min="0" value={f.amount} onChange={e=>s('amount',e.target.value)} required/></Field>
              <Field label="Date" required><input className="input" type="date" value={f.expense_date} onChange={e=>s('expense_date',e.target.value)} required/></Field>
              <Field label="Vehicle (optional)">
                <select className="input" value={f.vehicle_id} onChange={e=>s('vehicle_id',e.target.value)}>
                  <option value="">None</option>
                  {vehicles.map(v=><option key={v.id} value={v.id}>{v.name} ‚Äî {v.license_plate}</option>)}
                </select>
              </Field>
              <Field label="Receipt Ref"><input className="input" value={f.receipt_ref} onChange={e=>s('receipt_ref',e.target.value)} placeholder="Receipt number"/></Field>
            </div>
            <div style={{marginTop:14}}><Field label="Description"><textarea className="input" rows={2} value={f.description} onChange={e=>s('description',e.target.value)}/></Field></div>
            <div className="btn-row" style={{marginTop:18}}>
              <button type="button" className="btn btn-ghost" onClick={()=>setModal(false)}>Cancel</button>
              <button type="submit" className="btn btn-primary" disabled={fLoading}>{fLoading?'Saving‚Ä¶':'Add Expense'}</button>
            </div>
          </form>
        </Modal>
      )}
    </div>
  );
};

// ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NAV = [
  { id:'dashboard', label:'Dashboard',   icon:'üìä' },
  { id:'vehicles',  label:'Vehicles',    icon:'üöõ' },
  { id:'drivers',   label:'Drivers',     icon:'üë§' },
  { id:'trips',     label:'Trips',       icon:'üõ£' },
  { id:'fuel',      label:'Fuel Logs',   icon:'‚õΩ' },
  { id:'maintenance',label:'Maintenance',icon:'üîß' },
  { id:'expenses',  label:'Expenses',    icon:'üßæ' },
];

// ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const App = () => {
  const [user, setUser] = useState(null);
  const [page, setPage] = useState('dashboard');
  const [booting, setBooting] = useState(true);

  useEffect(() => {
    const token = localStorage.getItem('ff_token');
    if (token) {
      api.me().then(setUser).catch(()=>localStorage.removeItem('ff_token')).finally(()=>setBooting(false));
    } else { setBooting(false); }
  }, []);

  const logout = () => { localStorage.removeItem('ff_token'); setUser(null); setPage('dashboard'); };

  if (booting) return <div style={{display:'flex',alignItems:'center',justifyContent:'center',height:'100vh',background:'#09090b'}}><div className="spinner" style={{margin:0}}/></div>;
  if (!user) return <LoginPage onLogin={u=>{setUser(u);setPage('dashboard');}}/>;

  const pages = { dashboard:<Dashboard navigate={setPage}/>, vehicles:<VehiclesPage/>, drivers:<DriversPage/>, trips:<TripsPage/>, fuel:<FuelPage/>, maintenance:<MaintenancePage/>, expenses:<ExpensesPage/> };

  return (
    <div className="app">
      <aside className="sidebar">
        <div className="logo">
          <div className="logo-icon">üöõ</div>
          <span className="logo-text">FLEETFLOW</span>
        </div>
        <nav className="nav">
          {NAV.map(n=>(
            <button key={n.id} className={`nav-item ${page===n.id?'active':''}`} onClick={()=>setPage(n.id)}>
              <span className="nav-icon">{n.icon}</span>
              <span>{n.label}</span>
            </button>
          ))}
        </nav>
        <div className="user-bar">
          <div className="user-name">{user.full_name}</div>
          <div className="user-email">{user.email}</div>
          {user.roles?.map(r=><span key={r} className="role-tag">{r.replace(/_/g,' ')}</span>)}
          <br/>
          <button className="logout-btn" onClick={logout} style={{marginTop:8}}>‚éã Sign out</button>
        </div>
      </aside>
      <main className="main">
        <div className="page" key={page}>
          {pages[page]}
        </div>
      </main>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
